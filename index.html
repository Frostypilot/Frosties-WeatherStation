<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Logger</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #1e1e2f;
      color: #ffffff;
      margin: 0;
      padding: 0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #2a2a3d;
      font-size: 16px;
    }
    .status {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .container {
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .card {
      background-color: #2a2a3d;
      border-radius: 10px;
      padding: 20px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 20px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.5);
    }
    .chart-container {
      width: 90%;
      max-width: 800px;
      margin: 20px auto;
      background-color: #2a2a3d;
      padding: 10px;
      border-radius: 10px;
    }
    canvas {
      background-color: #1e1e2f;
      height: 400px;
    }
    @media (max-width: 768px) {
      .header {
        font-size: 14px;
      }
      .card {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="status">
      <span><strong>Wi-Fi:</strong></span>
      <span id="wifiSignal">Fetching...</span>
    </div>
    <div class="status">
      <span><strong>Battery:</strong></span>
      <span id="batteryPercentage">Fetching...</span>%
    </div>
  </div>

  <div class="container">
    <div class="card">
      <h1>Weather Logger</h1>
      <p><strong>Last Recording:</strong> <span id="lastRecording">Fetching...</span></p>
      <p><strong>Temperature:</strong> <span id="temperature">Fetching...</span> &#8451; (<span id="tempComfort">Fetching...</span>)</p>
      <p><strong>Humidity:</strong> <span id="humidity">Fetching...</span> % (<span id="humidityComfort">Fetching...</span>)</p>
      <p><strong>Battery Voltage:</strong> <span id="batteryVoltage">Fetching...</span> V</p>
    </div>
    <div class="chart-container">
      <canvas id="temperatureChart"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="humidityChart"></canvas>
    </div>
  </div>

  <script>
    const channelID = "2802750"; // Replace with your ThingSpeak Channel ID
    const readAPIKey = "3X1RW3MH5GLS1F9S"; // Replace with your ThingSpeak Read API Key

    async function fetchRealTimeData() {
      try {
        const response = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=1`);
        const data = await response.json();
        const feed = data.feeds[0];

        const temperature = parseFloat(feed.field1).toFixed(2);
        const humidity = parseFloat(feed.field2).toFixed(2);
        const batteryVoltage = parseFloat(feed.field3).toFixed(2);
        const batteryPercentage = parseFloat(feed.field4).toFixed(2);
        const lastRecording = new Date(feed.created_at).toLocaleString();

        document.getElementById("temperature").textContent = temperature;
        document.getElementById("humidity").textContent = humidity;
        document.getElementById("batteryVoltage").textContent = batteryVoltage;
        document.getElementById("batteryPercentage").textContent = batteryPercentage;
        document.getElementById("lastRecording").textContent = lastRecording;

        let tempComfort = "Comfortable";
        if (temperature < 10) tempComfort = "Cold";
        else if (temperature > 30) tempComfort = "Hot";
        document.getElementById("tempComfort").textContent = tempComfort;

        let humidityComfort = "Comfortable";
        if (humidity < 30) humidityComfort = "Dry";
        else if (humidity > 70) humidityComfort = "Humid";
        document.getElementById("humidityComfort").textContent = humidityComfort;

        document.getElementById("wifiSignal").textContent = `${Math.floor(Math.random() * 100)}%`;
      } catch (error) {
        console.error("Error fetching real-time data:", error);
      }
    }

    async function fetchHistoricalData() {
      try {
        const response = await fetch(`https://api.thingspeak.com/channels/${channelID}/feeds.json?api_key=${readAPIKey}&results=288`);
        const data = await response.json();
        const feeds = data.feeds;

        const hourlyFeeds = feeds.filter((feed, index) => index % 12 === 0);
        const timestamps = hourlyFeeds.map(feed => {
          const date = new Date(feed.created_at);
          return `${date.getHours()}:00`; // Round to the nearest hour
        });
        const temperatures = hourlyFeeds.map(feed => parseFloat(feed.field1));
        const humidities = hourlyFeeds.map(feed => parseFloat(feed.field2));

        const tempMin = Math.min(...temperatures);
        const tempMax = Math.max(...temperatures);
        const humidityMin = Math.min(...humidities);
        const humidityMax = Math.max(...humidities);

        createChart(
          'temperatureChart',
          `Temperature (Â°C) - Min: ${tempMin.toFixed(1)}, Max: ${tempMax.toFixed(1)}`,
          timestamps,
          temperatures,
          'rgba(255, 99, 132, 0.5)',
          'rgba(255, 99, 132, 1)',
          tempMin - 5,
          tempMax + 5
        );

        createChart(
          'humidityChart',
          `Humidity (%) - Min: ${humidityMin.toFixed(1)}, Max: ${humidityMax.toFixed(1)}`,
          timestamps,
          humidities,
          'rgba(54, 162, 235, 0.5)',
          'rgba(54, 162, 235, 1)',
          humidityMin - 5,
          humidityMax + 5
        );
      } catch (error) {
        console.error("Error fetching historical data:", error);
      }
    }

    function createChart(canvasId, label, labels, data, bgColor, borderColor, yMin, yMax) {
      new Chart(document.getElementById(canvasId), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            backgroundColor: bgColor,
            borderColor: borderColor,
            borderWidth: 1,
            pointRadius: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: label,
              font: {
                size: 16
              },
              color: '#ffffff'
            }
          },
          scales: {
            x: {
              ticks: {
                maxTicksLimit: 10, // Ensure only key times show
              }
            },
            y: {
              min: yMin,
              max: yMax,
              ticks: {
                padding: 10
              }
            }
          }
        }
      });
    }

    setInterval(fetchRealTimeData, 5000);
    fetchRealTimeData();
    fetchHistoricalData();
  </script>
</body>
</html>
